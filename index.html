<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivek's Technical Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .banner {
            background-color: #e0f2f7; /* Light blue */
            color: #2196f3; /* Darker blue */
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        #chart-container {
            min-height: 500px; /* Ensure space for chart */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            color: #777;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid #2196f3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Vivek's Technical Analysis</h1>

        <div id="banner" class="banner hidden"></div>

        <div class="input-section">
            <input type="text" id="symbolInput" placeholder="Enter Stock Symbol (e.g., UMHL)"
                   class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="loadChartBtn"
                    class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Load Chart
            </button>
        </div>

        <div id="chart-container" class="w-full h-96 flex items-center justify-center text-gray-500">
            Enter a stock symbol and click "Load Chart" to see the analysis.
        </div>
    </div>

    <script>
        // IMPORTANT: REPLACE THIS WITH YOUR RENDER PROXY URL!
        const PROXY_BASE_URL = "https://proxy-charts.onrender.com"; 
        // Example: "https://viveks-stock-proxy.onrender.com"

        const symbolInput = document.getElementById('symbolInput');
        const loadChartBtn = document.getElementById('loadChartBtn');
        const chartContainer = document.getElementById('chart-container');
        const banner = document.getElementById('banner');

        let debounceTimeout;

        loadChartBtn.addEventListener('click', loadChart);
        symbolInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadChart();
            }
        });

        function showLoading() {
            chartContainer.innerHTML = '<div class="loading-spinner"></div>';
            chartContainer.classList.add('flex', 'justify-center', 'items-center');
            banner.classList.add('hidden'); // Hide banner while loading
        }

        function showMessage(msg, type = 'info') {
            banner.textContent = msg;
            banner.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                banner.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                banner.classList.add('bg-green-100', 'text-green-700');
            } else { // info
                banner.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        async function loadChart() {
            clearTimeout(debounceTimeout); // Clear any previous debounce
            const symbol = symbolInput.value.trim().toUpperCase();

            if (!symbol) {
                showMessage("Please enter a stock symbol.", 'error');
                return;
            }

            showLoading();
            showMessage(`Fetching data for ${symbol}...`, 'info');

            try {
                const response = await fetch(`${PROXY_BASE_URL}/proxy`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        output: `full_data_component_${symbol}`,
                        output_unfiltered: `full_data_component_${symbol}`,
                        inputs: [{
                            id: 'stock_symbol_input',
                            property: 'value',
                            value: symbol
                        }],
                        changedProps: ['stock_symbol_input.value']
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                
                // Check if the expected 'full_data_component_' key exists in the data
                const componentKey = `full_data_component_${symbol}`;
                if (data && data.response && data.response[componentKey] && data.response[componentKey].props && data.response[componentKey].props.figure) {
                    const figure = data.response[componentKey].props.figure;
                    Plotly.newPlot(chartContainer, figure.data, figure.layout);
                    showMessage(`Chart for ${symbol} loaded successfully!`, 'success');
                } else {
                    throw new Error("Invalid or unexpected data format received from the proxy.");
                }

            } catch (error) {
                console.error("Error loading chart:", error);
                let errorMessage = `Failed to load chart for ${symbol}.`;
                if (error.message.includes("Failed to fetch")) {
                    errorMessage += " Please check the proxy server and your internet connection.";
                } else if (error.message.includes("404")) {
                    errorMessage += " The proxy endpoint might be incorrect or the target service is not found.";
                } else {
                    errorMessage += ` Error details: ${error.message}`;
                }
                showMessage(errorMessage, 'error');
                chartContainer.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
            }
        }

        // Initial message when page loads
        showMessage("Enter a stock symbol to get started.", 'info');
        chartContainer.innerHTML = `<p class="text-gray-500">Enter a stock symbol and click "Load Chart" to see the analysis.</p>`;
    </script>
</body>
</html>
